# Результаты Аудита Безопасности и Исправления

## 1. Конфигурация Настроек для Продакшена (Production)
**Важность:** Высокая
**Местоположение:** `config/settings.py`

**Проблема:**
Критические настройки безопасности для рабочей среды (продакшена) в данный момент отсутствуют или полагаются на небезопасные значения по умолчанию.
- `SECURE_SSL_REDIRECT`: Не установлено (должно быть `True` в продакшене).
- `SESSION_COOKIE_SECURE`: Не установлено (должно быть `True` для HTTPS).
- `CSRF_COOKIE_SECURE`: Не установлено (должно быть `True` для HTTPS).
- `X_FRAME_OPTIONS`: Используется middleware по умолчанию, но рекомендуется явная конфигурация.
- `SECURE_HSTS_SECONDS`: Отсутствует (Strict-Transport-Security).

**Рекомендация:**
Обновите `config/settings.py`, добавив проверку на режим продакшена (DEBUG=False) или используя отдельный файл настроек.

```python
if not DEBUG:
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True
    SECURE_HSTS_SECONDS = 31536000  # 1 год
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    X_FRAME_OPTIONS = 'DENY'
```

## 2. Обработка Общих Исключений
**Важность:** Низкая
**Местоположение:** `apps/orders/views.py` (строки 74-77)

**Проблема:**
Вью `checkout` перехватывает общее исключение `Exception` и выводит трассировку стека (traceback) в стандартный вывод консоли, используя `traceback.print_exc()`. В продакшене это может привести к утечке информации в логи, которые не защищены должным образом, или просто засорять вывод.

**Рекомендация:**
Используйте модуль `logging` вместо `traceback.print_exc()`.

```python
import logging
logger = logging.getLogger(__name__)

# ... внутри блока except
logger.error(f"Checkout error: {e}", exc_info=True)
```

## 3. Идемпотентность Вебхуков и Атаки Повтора (Replay Attacks)
**Важность:** Средняя
**Местоположение:** `apps/payments/views.py`

**Проблема:**
Вебхук проверяет подпись, что хорошо. Однако он явно не проверяет атаки повторного воспроизведения (например, не проверяет временную метку, хотя NOWPayments может и не гарантировать её наличие) и не обеспечивает полную идемпотентность. Если вебхук придет дважды, код попытается обновить статус заказа повторно. Хотя в данном случае это почти безвредно (повторная установка статуса 'paid'), хорошей практикой является проверка текущего статуса.

**Рекомендация:**
Проверяйте, оплачен ли заказ, прежде чем обрабатывать статус 'finished' снова.

```python
if payment_status == 'finished' or payment_status == 'confirmed':
    if order.status != 'paid':
        order.status = 'paid'
        order.save()
        send_payment_success_email.delay(order.id)
```

## 4. Валидация Входных Данных
**Важность:** Низкая
**Местоположение:** Общее

**Проблема:**
Хотя Django Forms обрабатывают большую часть валидации, убедитесь, что `OrderForm` в `apps/orders/forms.py` строго определяет разрешенные поля (`fields = [...]` вместо `__all__`), чтобы предотвратить изменение полей, которые не должны быть доступны пользователю (Mass Assignment vulnerability).

**Рекомендация:**
Проверьте, что в `OrderForm` явно перечислены безопасные поля.

## 5. Управление Зависимостями
**Важность:** Средняя
**Местоположение:** `requirements.txt`

**Проблема:**
Версии зависимостей должны быть жестко зафиксированы (pinned), чтобы предотвратить атаки на цепочку поставок или поломки из-за автоматических обновлений.

**Рекомендация:**
Выполните `pip freeze > requirements.txt`, чтобы зафиксировать точные версии всех установленных пакетов.

## 6. Защита Заголовка Host
**Важность:** Низкая
**Местоположение:** `config/settings.py`

**Проблема:**
`ALLOWED_HOSTS` настроен через переменную окружения, что верно. Убедитесь, что в продакшене там указан только ваш реальный домен, и никогда не используется `*`.

**Рекомендация:**
Убедитесь, что в файле `.env` на продакшене установлены строгие значения для `ALLOWED_HOSTS`.
